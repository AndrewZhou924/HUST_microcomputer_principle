#INCLUDE p16f1786.inc  
__CONFIG _CONFIG1, _FOSC_ECH & _WDTE_OFF & _PWRTE_OFF & _MCLRE_ON & _CP_OFF & _CPD_OFF & _BOREN_ON & _CLKOUTEN_OFF & _IESO_ON & _FCMEN_ON
 __CONFIG _CONFIG2, _WRT_OFF & _VCAPEN_OFF & _PLLEN_ON & _STVREN_ON & _BORV_LO & _LPBOR_OFF & _LVP_ON
;程序外设说明：
; 本次实验所用到的外设主要为4位数码管，其端口接法为a-f接PortA的0-7
; 其选择口接到PortC的0-3
; PORTA输出高电平有效，PORTC输出低电平有效
; 此外还有电平变化中断引脚RB5，备用指示引脚为PortB的引脚
 
UDATA_SHR
OFFSET RES 1
COFFSET RES 1
NUM RES 1
CNUM RES 1
PA RES 1
CNT RES 1
DELAYTIME1 RES 1
DELAYTIME2 RES 1
DELAYTIME3 RES 1 
ISBLACK RES 1
 
RES_VECT  CODE    0x0000            ; processor reset vector
GOTO    FIRST                   ; go to beginning of program
MAIN_PROG CODE                      ; let linker place main program

ISR CODE 0x04 ;所有中断代码
;区分各类中断执行不同的函数
EX_INT;外部中断执行程序	
BTFSC INTCON,0;判断电平变化中断标志位是否为1，为1跳转执行外部中断代码
CALL PORTB_INT
TM0_INT;timer0中断执行程序
BTFSC INTCON,TMR0IF
CALL TMR0_INT;;;;;;;;;;;;;;;;;;;;;
;
;
CALL BLACK
BANKSEL INTCON
BCF INTCON,2 ;清除timer0的标志位，重新装入初值
BANKSEL TMR0
MOVLW B'01111111'
; MOVLW B'00000000';装入timer0初值
MOVWF TMR0
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; 
RETFIE;

CODE
FIRST;初始化单片机各个外设代码

BANKSEL OPTION_REG
MOVLW B'00000111'
MOVWF OPTION_REG ;;;;;;;;;;;;;;;;;;;;;TMR0设置为256分频
 
BANKSEL TMR0
;MOVLW B'01111111';装入timer0初值
MOVLW B'00000000';装入timer0初值
MOVWF TMR0

BANKSEL INTCON
MOVLW B'11101000'
MOVWF INTCON;使能电平变化中断和总中断和TIMER0中断

BANKSEL TRISC
CLRF TRISC
BANKSEL PORTC
MOVLW B'11111111'
MOVWF PORTC;初始化端口C，将端口C设为输出模式
 
BANKSEL TRISA
CLRF TRISA
BANKSEL LATA
CLRF LATA
BANKSEL ANSELA
;CLRF ANSELA
MOVLW B'00000000'
MOVWF ANSELA

BANKSEL TRISB
MOVLW B'00100000'
MOVWF TRISB
;RB5为输入模式
BANKSEL IOCBN
MOVLW B'00100000'
MOVWF IOCBN
;RB5为下降沿触发
BANKSEL PORTB
CLRF PORTB
BANKSEL WPUB
MOVLW B'00100000'
MOVWF WPUB;弱上拉RB5，IO电平变化中断为RB5引脚触发

BANKSEL OSCCON
; MOVLW B'00001000'
MOVLW B'00101011'
MOVWF OSCCON ;;;;;;;;;;;;;;;;;;;;;;振荡器设置为?KHZ，内部振荡器

BANKSEL COFFSET
MOVLW D'22'
MOVWF COFFSET;十个数字显示

BANKSEL CNUM
MOVLW D'1'
MOVWF CNUM;;;;;;;;;;;;;;;;;;;;;;;;;4个数码管

MOVF COFFSET,W
MOVWF PA;;;;;;;;;;;;;;;;;;;;;;;;;;;PA暂时存储COFFSET

MOVLW D'4'
MOVWF CNT;;;;;;;;;;;;;;;;;;;;;;;;;;计数四次

CLRF ISBLACK

PAGESEL MAIN
GOTO MAIN

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;这里是函数区;;;;;;;;;;;;;;;;;
SELECT:
BANKSEL PORTA
CLRF PORTA
BANKSEL LATA
MOVLW B'00000000'
MOVWF  LATA
BANKSEL PORTC
MOVLW B'11111111'
MOVWF PORTC
MOVLW LOW STABLE ;获得TABLE的低8位
ADDWF NUM,F;TABLE值加上偏移量
MOVLW HIGH STABLE;获得TABLE的高5位
BTFSC STATUS,C;检测是否翻页
ADDLW 1;翻页则在TABLE的高5位加一
MOVWF PCLATH;将TABLE的高5位写入PCLATH
MOVF NUM,W;将需要调用的信号的地址写入W
CALL STABLE;
MOVWF PORTC
RETURN

STABLE:
MOVWF PCL;转到偏移的地址
RETLW B'00000001';1
RETLW B'00000010';2
RETLW B'00000100';3
RETLW B'00001000';4    
;RETLW B'00000001';1
;RETLW B'00000001';1
;RETLW B'00000001';1
;RETLW B'11111101';2
;RETLW B'11111011';3
;RETLW B'11110111';4

WRITE:
MOVLW LOW TABLE ;获得TABLE的低8位
ADDWF OFFSET,F;TABLE值加上偏移量
MOVLW HIGH TABLE;获得TABLE的高5位
BTFSC STATUS,C;检测是否翻页
ADDLW 1;翻页则在TABLE的高5位加一
MOVWF PCLATH;将TABLE的高5位写入PCLATH
MOVF OFFSET,W;将需要调用的信号的地址写入W
CALL TABLE;
MOVWF LATA
; CALL DELAY
RETURN

TABLE:
MOVWF PCL;转到偏移的地址
RETLW B'10010000';9
RETLW B'10000000';8
RETLW B'11111000';7
RETLW B'10000010';6
RETLW B'10010010';5
RETLW B'10011001';4
RETLW B'10110000';3
RETLW B'10100100';2
RETLW B'11111001';1
RETLW B'11000000';0
RETLW B'00000000';NULL??11
RETLW B'00000000';NULL??12
RETLW B'00000000';NULL??13
RETLW B'00000000';NULL??14
RETLW B'01011110';d??15
RETLW B'01111001';E??16
RETLW B'01111001';E????17
RETLW B'01101101';S??18
RETLW B'00000000';NULL??19
RETLW B'00000000';NULL??20
RETLW B'00000000';NULL??21
RETLW B'00000000';NULL??22



SETORIGIN:
MOVLW D'1'
MOVWF CNUM
MOVLW D'4'
MOVWF CNT
MOVF COFFSET,W
MOVWF PA
RETURN

SETPA:
MOVLW D'10'
MOVWF PA
RETURN

SETCOFFSET:
MOVLW D'10'
MOVWF COFFSET
RETURN

DELAY:                         
MOVLW 2           
MOVWF DELAYTIME1        
DELAY_1
MOVLW .20     
MOVWF DELAYTIME2      
DELAY_2
MOVLW .20          
MOVWF DELAYTIME3      
DELAY_3
DECFSZ DELAYTIME3,1        
GOTO DELAY_3      
DECFSZ DELAYTIME2,1         
GOTO DELAY_2        
DECFSZ DELAYTIME1,1         
GOTO DELAY_1        
RETURN            ;延时函数，主要用于开机动画和黑屏的延时

DECRESE_COFFSET:
DECF COFFSET
BTFSC STATUS,Z
CALL SETCOFFSET
RETURN

BLACK:
BANKSEL PORTA
CLRF PORTA
BANKSEL LATA
CLRF LATA
CALL DELAY
RETURN

TMR0_INT:
BCF INTCON,TMR0IF
DECF COFFSET
BTFSC STATUS,Z
CALL SETCOFFSET;;;;;;;;;;;;;;;;;;;;;;;;;;;;;COFFSET减一

RETURN

PORTB_INT:
BANKSEL PORTB
BCF PORTB,4
BANKSEL IOCBF
BCF IOCBF,5 ;;;;;;;;;;;;;;;;;;;;;;;;;;;PORTB中断标志清除
MOVLW D'10'
MOVWF COFFSET
RETURN
;;;;;;;;;;函数区到此为止;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;



MAIN
LOOP
MOVF CNUM,W
MOVWF NUM;数码管
MOVF PA,W
MOVWF OFFSET;图案

CALL SELECT;数码管
CALL WRITE;图案

DECF PA
BTFSC STATUS,Z;PA偏移量减一,若为零则重新赋值
CALL SETPA;
INCF CNUM
DECF CNT
BTFSC STATUS,Z
CALL SETORIGIN

GOTO LOOP
END